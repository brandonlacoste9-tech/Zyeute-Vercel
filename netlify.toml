# Netlify Configuration for Vite + React SPA
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/

# IMPORTANT: This is a Vite app, NOT Next.js
# Disable Next.js auto-detection
[build]
  # Command to build your Vite project for production
  # This runs 'vite build' which outputs to the 'dist' directory by default
  command = "npm run build"
  
  # Directory containing the built static files
  # Vite outputs to 'dist' by default (configured in vite.config.ts)
  publish = "dist"
  
  # Set Node.js version for the build environment
  # Using Node 20.19.0+ as required by Vite 7.2.4 and other dependencies
  [build.environment]
    NODE_VERSION = "20.19.0"
    # Disable Next.js plugin auto-detection
    NETLIFY_NEXT_PLUGIN_SKIP = "true"

# SPA routing: Standard Netlify rewrite for React Router
# All unknown paths serve index.html (200 status = rewrite, not redirect)
# This is the recommended pattern from Netlify docs for Vite/React SPAs
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# Headers for optimized caching of static assets
# Netlify automatically handles index.html caching with atomic deploys
# Hashed assets can be cached long-term since hashes change on content updates
[[headers]]
  # Apply these headers to all asset files in the /assets directory
  for = "/assets/*"
  [headers.values]
    # Cache static assets for 1 year (they are hashed, so this is safe)
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  # Security headers for all pages
  for = "/*"
  [headers.values]
    # Content Security Policy (includes Stripe domains)
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://m.stripe.com; script-src-elem 'self' 'unsafe-inline' https://js.stripe.com https://m.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data: https://r2cdn.perplexity.ai; connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co https://api.stripe.com https://m.stripe.com https://m.stripe.network; frame-src 'self' https://js.stripe.com https://hooks.stripe.com https://m.stripe.com; object-src 'none'; base-uri 'self'; form-action 'self';"
    # Prevent clickjacking attacks
    X-Frame-Options = "DENY"
    # Prevent MIME type sniffing
    X-Content-Type-Options = "nosniff"
    # Enable XSS protection
    X-XSS-Protection = "1; mode=block"
    # Enforce HTTPS
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# Development settings
[dev]
  # Command to run local dev server
  command = "npm run dev"
  # Port for local development (matches vite.config.ts)
  port = 5173
  # Auto-open browser on dev server start
  autoLaunch = false

# Deploy contexts for different environments
[context.production]
  # Production-specific settings
  # Uses production Supabase project
  # Environment variables should be set in Netlify UI for security:
  #   VITE_SUPABASE_URL (production project URL)
  #   VITE_SUPABASE_ANON_KEY (production anon key)

[context.deploy-preview]
  # Preview deployments (for PRs)
  # Uses 'dev-preview-main' Supabase branch for isolated testing
  # Environment variables required in Netlify UI with scope "Deploy previews":
  #   VITE_SUPABASE_URL_PREVIEW (preview branch URL)
  #   VITE_SUPABASE_ANON_KEY_PREVIEW (preview branch anon key)
  # 
  # To set up:
  # 1. Create Supabase preview branch: supabase branches create dev-preview-main
  # 2. Get credentials: supabase branches get dev-preview-main
  # 3. Add credentials in Netlify: Site settings > Environment variables
  # 4. Scope: "Deploy previews" only
  #
  # See SUPABASE_PREVIEW_SETUP.md for detailed instructions

[context.branch-deploy]
  # Branch deployments
  # Uses same configuration as deploy-preview
  # Inherits preview Supabase branch settings

# Functions configuration for Stripe integration
[functions]
  directory = "netlify/functions"
  # Node.js version for functions (must match build environment)
  node_bundler = "esbuild"

# IMPORTANT: Next.js plugin is disabled via NETLIFY_NEXT_PLUGIN_SKIP environment variable
# Netlify auto-detects Next.js and injects vercel.live scripts
# Setting NETLIFY_NEXT_PLUGIN_SKIP = "true" prevents this
# If the plugin was added in Netlify UI, remove it from Site settings > Plugins

# Plugins (optional - uncomment as needed)
# [[plugins]]
#   package = "@netlify/plugin-lighthouse"
#
# [[plugins]]
#   package = "netlify-plugin-cache"


