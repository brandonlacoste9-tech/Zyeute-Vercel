# ============================================
# Netlify Configuration for Vite + React SPA
# ============================================
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/

# IMPORTANT: This is a Vite app, NOT Next.js
# Disable Next.js auto-detection

[build]
  # Command to build your Vite project for production
  # This runs 'vite build' which outputs to the 'dist' directory by default
  command = "npm run build"
  
  # Directory containing the built static files
  # Vite outputs to 'dist' by default (configured in vite.config.ts)
  publish = "dist"

# Set Node.js version for the build environment
# Using Node 20.19.0+ as required by Vite 7.2.4 and other dependencies
[build.environment]
  NODE_VERSION = "20.19.0"
  # Disable Next.js plugin auto-detection
  NETLIFY_NEXT_PLUGIN_SKIP = "true"

# ============================================
# STATIC ASSETS - Serve as-is (MUST BE FIRST)
# ============================================
# CRITICAL: These rules MUST come BEFORE the SPA fallback
# Otherwise, asset requests will be intercepted and served as HTML

# Vite build outputs all hashed JS/CSS to /assets/ directory
[[redirects]]
  from = "/assets/*"
  to = "/assets/:splat"
  status = 200

# Service Worker must be served from root
[[redirects]]
  from = "/sw.js"
  to = "/sw.js"
  status = 200

# PWA manifest
[[redirects]]
  from = "/manifest.json"
  to = "/manifest.json"
  status = 200

# Common static file extensions
[[redirects]]
  from = "/*.js"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.css"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.png"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.jpg"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.jpeg"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.gif"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.svg"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.ico"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.webp"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.woff"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.woff2"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.ttf"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.eot"
  to = "/:splat"
  status = 200

[[redirects]]
  from = "/*.otf"
  to = "/:splat"
  status = 200

# ============================================
# SPA FALLBACK - MUST BE LAST
# ============================================
# All unknown paths serve index.html (200 status = rewrite, not redirect)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# ============================================
# SECURITY HEADERS (CSP + additional protections)
# ============================================
# Netlify automatically handles index.html caching with atomic deploys
# Hashed assets can be cached long-term since hashes change on content updates

[[headers]]
  # Apply these headers to all pages
  for = "/*"
  [headers.values]
    # Content Security Policy (includes Stripe domains)
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://m.stripe.com https://translate.google.com https://translate.googlesyndication.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://r2cdn.perplexity.ai https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://js.stripe.com https://m.stripe.com; img-src 'self' data: blob: https:; media-src 'self' blob: https:; object-src 'none'; frame-ancestors 'none';"
    # Prevent MIME type sniffing
    X-Content-Type-Options = "nosniff"
    # Prevent clickjacking
    X-Frame-Options = "DENY"
    # Enable XSS protection
    X-XSS-Protection = "1; mode=block"
    # Enforce HTTPS
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    # Control referrer information
    Referrer-Policy = "strict-origin-when-cross-origin"

# Ensure JS files serve with correct MIME type
[[headers]]
  for = "/assets/*.js"
  [headers.values]
    Content-Type = "application/javascript; charset=utf-8"
    # Hashed chunks are immutable, cache for 1 year
    Cache-Control = "public, max-age=31536000, immutable"

# Ensure CSS files serve with correct MIME type
[[headers]]
  for = "/assets/*.css"
  [headers.values]
    Content-Type = "text/css; charset=utf-8"
    # Hashed chunks are immutable, cache for 1 year
    Cache-Control = "public, max-age=31536000, immutable"

# ============================================
# DEVELOPMENT SETTINGS
# ============================================

[dev]
  # Command to run local dev server
  command = "npm run dev"
  # Port for local development (matches vite.config.ts)
  port = 5173
  # Auto-open browser on dev server start
  autoLaunch = false

# ============================================
# DEPLOY CONTEXTS FOR DIFFERENT ENVIRONMENTS
# ============================================

[context.production]
  # Production-specific settings
  # Uses production Supabase project
  # Environment variables should be set in Netlify UI for security:
  #  VITE_SUPABASE_URL (production project URL)
  #  VITE_SUPABASE_ANON_KEY (production anon key)

[context.deploy-preview]
  # Preview deployments (for PRs)
  # Uses "dev-preview-main" Supabase branch for isolated testing
  # Environment variables required in Netlify UI with scope "Deploy previews":
  #  VITE_SUPABASE_URL_PREVIEW (preview branch URL)
  #  VITE_SUPABASE_ANON_KEY_PREVIEW (preview anon key)
  #
  # To set up:
  # 1. Create Supabase preview branch: supabase branches create dev-preview-main
  # 2. Get credentials: supabase branches get dev-preview-main
  # 3. Add as environment variables in Netlify UI with scope "Deploy previews"

# ============================================
# BRANCH DEPLOY CONFIGURATION
# ============================================
# Uncomment below to enable automatic deploys for specific branches:
# 
# [[redirects]]
#   from = "/*"
#   to = "/:splat"
#   status = 200
